<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.backend.Mappers.SentenceMapper">

    <!-- Result mapping: Database underscore fields → DO camelCase fields -->
    <resultMap id="SentenceResultMap" type="com.example.backend.POJO.DO.SentenceDO">
        <id column="id" property="id"/>  <!-- Primary key -->
        <result column="sentence" property="sentence"/>
        <!-- Core: Database create_date → DO's createDate; type automatically adapts to LocalDateTime -->
        <result column="create_date" property="createDate"/>
        <!-- Database create_by → DO's createBy -->
        <result column="create_by" property="createBy"/>
    </resultMap>

    <!-- Insert: exclude id (auto-increment), field names match database -->
    <insert id="insert" parameterType="com.example.backend.POJO.DO.SentenceDO">
        INSERT INTO sentence (
        sentence, create_date, create_by
        ) VALUES (
        #{sentence}, #{createDate}, #{createBy}
        )
        <!-- Backfill auto-increment ID to DO's id field -->
        <selectKey keyProperty="id" order="AFTER" resultType="java.lang.Long">
            SELECT LAST_INSERT_ID()
        </selectKey>
    </insert>

    <!-- Delete: parameter type Long (matches DO's id type) -->
    <delete id="deleteById" parameterType="java.lang.Long">
        DELETE FROM sentence WHERE id = #{id}
    </delete>

    <!-- Update: field names match database, only update business fields -->
    <update id="updateById" parameterType="com.example.backend.POJO.DO.SentenceDO">
        UPDATE sentence
        SET
            sentence = #{sentence},
            create_date = #{createDate},
            create_by = #{createBy}
        WHERE id = #{id}
    </update>

    <!-- Query by ID: only query fields that exist in database -->
    <select id="selectById" parameterType="java.lang.Long" resultMap="SentenceResultMap">
        SELECT id, sentence, create_date, create_by
        FROM sentence
        WHERE id = #{id}
    </select>

    <!-- random sentence-->
    <select id="selectRandomByJump" resultType="com.example.backend.POJO.DO.SentenceDO">
        SELECT * FROM sentence
        WHERE id >= (
            SELECT FLOOR(RAND() * (SELECT COALESCE(MAX(id), 1) FROM sentence)) + 1
        )
        ORDER BY id
            LIMIT 1
    </select>

    <!-- Query all: field names match database -->
    <select id="selectAll" resultMap="SentenceResultMap">
        SELECT id, sentence, create_date, create_by
        FROM sentence
    </select>

    <!-- Conditional query (supports fuzzy search by sentence content) -->
    <select id="selectByCondition" parameterType="String" resultMap="SentenceResultMap">
        SELECT id, sentence, create_date, create_by
        FROM sentence
        <where>
            <if test="sentence != null and sentence != ''">
                AND sentence LIKE CONCAT('%', #{sentence}, '%')
            </if>
        </where>
        ORDER BY id DESC
    </select>

</mapper>